{% extends 'base.html' %}
{% block content %}
<h1 class="mb-4">Dashboard</h1>

<!-- Top cards -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card text-bg-primary mb-3">
            <div class="card-body">
                <h5 class="card-title">Datasets</h5>
                <p class="card-text display-6">{{ datasets_count }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-bg-success mb-3">
            <div class="card-body">
                <h5 class="card-title">Models</h5>
                <p class="card-text display-6">{{ models_count }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-bg-warning mb-3">
            <div class="card-body">
                <h5 class="card-title">Predictions</h5>
                <p class="card-text display-6">{{ predictions_count }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Charts row -->
<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">System Overview</h5>
                <canvas id="summaryChart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Churn vs No Churn (Predictions)</h5>
                <canvas id="churnChart" height="200"></canvas>
                {% if predictions_count == 0 %}
                    <p class="text-muted small mt-2">
                        No predictions yet. Run a prediction to see this chart.
                    </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Recent Datasets -->
    <div class="col-md-6 mb-4">
        <h3>Recent Datasets</h3>
        <table class="table table-striped table-sm">
            <thead>
            <tr>
                <th>Name</th>
                <th>Rows</th>
                <th>Cols</th>
                <th>Uploaded</th>
                <th></th>
            </tr>
            </thead>
            <tbody>
            {% for d in datasets %}
                <tr>
                    <td>{{ d.name }}</td>
                    <td>{{ d.num_rows }}</td>
                    <td>{{ d.num_columns }}</td>
                    <td>{{ d.uploaded_at|date:"Y-m-d H:i" }}</td>
                    <td>
                        <a class="btn btn-sm btn-outline-success"
                           href="{% url 'analytics:train_model' d.id %}">
                            Train Model
                        </a>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="5">
                        No datasets yet.
                        <a href="{% url 'analytics:upload_dataset' %}">Upload one</a>.
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Latest Models (your existing table, just moved right) -->
    <div class="col-md-6 mb-4">
        <h3>Latest Models</h3>
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Dataset</th>
                    <th>Accuracy</th>
                    <th>F1 Score</th>
                    <th>Created</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for m in latest_models %}
                <tr>
                    <td>{{ m.name }}</td>
                    <td>{{ m.dataset.name }}</td>
                    <td>{{ m.accuracy|floatformat:2 }}</td>
                    <td>{{ m.f1_score|floatformat:2 }}</td>
                    <td>{{ m.created_at }}</td>
                    <td>
                        <a class="btn btn-sm btn-outline-primary"
                           href="{% url 'analytics:model_detail' m.id %}">
                           View
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="6">No models yet.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Summary bar chart
    const summaryCtx = document.getElementById('summaryChart').getContext('2d');
    const summaryChart = new Chart(summaryCtx, {
        type: 'bar',
        data: {
            labels: ['Datasets', 'Models', 'Predictions'],
            datasets: [{
                label: 'Count',
                data: [
                    {{ datasets_count|default:0 }},
                    {{ models_count|default:0 }},
                    {{ predictions_count|default:0 }}
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { precision: 0 }
                }
            }
        }
    });

    // Churn vs No Churn pie chart
    const churnCtx = document.getElementById('churnChart').getContext('2d');
    const churnChart = new Chart(churnCtx, {
        type: 'pie',
        data: {
            labels: ['Churn', 'No Churn'],
            datasets: [{
                data: [
                    {{ churn_count|default:0 }},
                    {{ no_churn_count|default:0 }}
                ]
            }]
        },
        options: {
            responsive: true
        }
    });
</script>
{% endblock %}
